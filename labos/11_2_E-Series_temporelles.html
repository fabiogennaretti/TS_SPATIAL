<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Time series - Lab 2</title>

<script src="libs/header-attrs-2.26/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/spacelab.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="libs/navigation-1.1/tabsets.js"></script>
<link href="libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div id="header">



<h1 class="title toc-ignore">Time series - Lab 2</h1>

</div>


<!-- This lab should be submitted to Moodle on April 21st. -->
<!-- **Numbers in parentheses indicate the number of points for each question.** -->
<!-- **Total: 12 points.** -->
<div id="data" class="section level2">
<h2>Data</h2>
<p>For this exercise we will use data from a flux tower located in a
black spruce forest near Chibougamau.</p>
<blockquote>
<p><strong>Reference</strong>: Bergeron, Margolis, Black, Coursolle,
Dunn, Barr, &amp; Wofsy. (2007). Comparison of carbon dioxide fluxes
over three boreal black spruce forests in Canada. Global Change Biology,
13(1), 89â€“107. <a
href="https://doi.org/10.1111/j.1365-2486.2006.01281.x"
class="uri">https://doi.org/10.1111/j.1365-2486.2006.01281.x</a>.</p>
</blockquote>
<p>Flux towers measure net ecosystem exchange or the amount of gas that
is exchanged between the atmosphere and the ecosystem using eddy
covariance technique.</p>
<blockquote>
<p><strong>Weblink</strong>: <a
href="https://www.neonscience.org/3d-interactive-flux-tower"
class="uri">https://www.neonscience.org/3d-interactive-flux-tower</a></p>
</blockquote>
<blockquote>
<p><strong>Weblink</strong>: <a
href="https://www.youtube.com/watch?v=CR4Anc8Mkas"
class="uri">https://www.youtube.com/watch?v=CR4Anc8Mkas</a></p>
</blockquote>
<!-- > **Weblink**: https://www.neonscience.org/data-collection/flux-tower-measurements -->
<blockquote>
<p><strong>Weblink</strong>: <a
href="https://www.neonscience.org/data-collection/meteorology"
class="uri">https://www.neonscience.org/data-collection/meteorology</a></p>
</blockquote>
<p>We will start loading the required packages and the data.</p>
<pre class="r"><code>library(fpp3)
library(dplyr)
library(ggplot2)
library(cowplot)
EOBS_fluxnet &lt;- read.csv(&quot;../donnees/EOBS_fluxnet2.csv&quot;)
head(EOBS_fluxnet)</code></pre>
<pre><code>##   Year Day GapFilled_NEP GapFilled_R GapFilled_GEP TimeSteps
## 1 2004   1    -0.3702583   0.3702583             0        48
## 2 2004   2    -0.3226569   0.3226569             0        48
## 3 2004   3    -0.3143513   0.3143513             0        48
## 4 2004   4    -0.3108769   0.3108769             0        48
## 5 2004   5    -0.3105173   0.3105173             0        48
## 6 2004   6    -0.3069446   0.3069446             0        48</code></pre>
<p>The columns are:</p>
<ul>
<li><p><em>Year</em> is the year of the observation</p></li>
<li><p><em>Day</em> is the day of the year of the observation
(1-365)</p></li>
<li><p><em>GapFilled_NEP</em> is the daily net ecosystem productivity
(<em>umol C m-2 of stand s-1</em>)</p></li>
<li><p><em>GapFilled_R</em> is the daily ecosystem respiration (<em>umol
C m-2 of stand s-1</em>)</p></li>
<li><p><em>GapFilled_GEP</em> is the daily gross ecosystem productivity
(<em>umol C m-2 of stand s-1</em>)</p></li>
<li><p><em>TimeSteps</em> is an integer saying how many half hourly data
composed the daily aggregates</p></li>
</ul>
</div>
<div id="process-and-explore-nep-time-series" class="section level2">
<h2>1. Process and explore NEP time series</h2>
<p><strong>(1a) Create a temporal data frame (<em>tsibble</em>). As a
first step, you must add a column containing the date using the
information in <em>Year</em> and <em>Day</em>. Consult the following
website to understand how to deal with date/time data in <em>R</em>: <a
href="https://www.stat.berkeley.edu/~s133/dates.html"
class="uri">https://www.stat.berkeley.edu/~s133/dates.html</a> (1
point)</strong></p>
<p><strong>(1b) One of the problems working with daily data is to deal
with leap years. In this case we load data with constant 365 days per
year. This is a common solution to simplify the data processing,
especially in modelling. In order to add one more day per each leap year
we can use the functions <em>fill_gaps</em> (<a
href="https://www.rdocumentation.org/packages/tsibble/versions/1.0.0/topics/fill_gaps"
class="uri">https://www.rdocumentation.org/packages/tsibble/versions/1.0.0/topics/fill_gaps</a>)
and <em>tidyr::fill</em> (<a
href="https://www.rdocumentation.org/packages/tidyr/versions/1.1.3/topics/fill"
class="uri">https://www.rdocumentation.org/packages/tidyr/versions/1.1.3/topics/fill</a>).
We can specify that the added rows have <em>Day</em> equal to 366 and
<em>GapFilled_NEP</em>, <em>GapFilled_R</em>, <em>GapFilled_GEP</em>,
and <em>Year</em> equal to the value of the preceding row. (1
point)</strong></p>
<p><strong>(1c) Obtain a new temporal data frame (<em>tsibble</em>)
containing mean monthly values of <em>GapFilled_NEP</em>. Plot the
obtained time series and comment it. How does the time series vary over
time? What do negative values mean? (1 point)</strong></p>
<p><strong>(1d) Plot the 3 time-series of daily values
(<em>GapFilled_NEP</em>, <em>GapFilled_R</em>, <em>GapFilled_GEP</em>),
the annual seasonality of <em>GapFilled_NEP</em> (use the daily dataset
as well as the monthly dataset providing two distinct plots), and the
trend of <em>GapFilled_NEP</em> data for each month over time (use the
monthly dataset). When does the growing season start and end at the
study site? When does the peak of photosynthesis occur? Is there any
evident trend in the mean monthly values? (1 point)</strong></p>
<p><strong>(1e) Extract the several components of the
<em>GapFilled_NEP</em> daily time series (trend, seasonality, and
residuals). What is the componentsâ€™ relative importance? What does it
mean? Finally, store the components into a new temporal data frame
(<em>tsibble</em>). (1 point)</strong></p>
<p><strong>(1f) Analyze the autocorrelation and the partial
autocorrelation of the <em>GapFilled_NEP</em> daily time series and of
its residual component extracted in 1e. What do you deduce from these
plots? (1 point)</strong></p>
</div>
<div id="gam-model-for-nep" class="section level2">
<h2>2. GAM model for NEP</h2>
<p><strong>(2a) Fit a Generalized Additive Model (GAM) on
<em>GapFilled_NEP</em> using Day of Year (DOY) as a smooth term. Plot
the estimated smooth function. Evaluate whether the model residuals meet
key assumptions: Homoscedasticity (residuals vs fitted), Normality
(QQ-plot), Absence of temporal autocorrelation (time series plot and
ACF). (1 point)</strong></p>
<p><strong>(2b) Extend the previous GAM by incorporating temporal
autocorrelation in the residuals using an AR correlation structure (p =
1, q = 0). Which model performs best (with or without temporal
autocorrelation)? Why? Do the residuals of the best model meet the
modelâ€™s assumptions (homoscedasticity, normality, no remaining temporal
autocorrelation)? (1 point)</strong></p>
</div>
<div id="gam-model-for-nep-with-external-predictors"
class="section level2">
<h2>3. GAM model for NEP with external predictors</h2>
<p>We will start loading meteorological data for the flux tower
site.</p>
<pre class="r"><code>My_meteo=read.delim(&quot;../donnees/EOBS_fluxnet_inmet2.txt&quot;,skip=1,header=F)
names(My_meteo)= c(&quot;Year&quot;,&quot;Day&quot;,&quot;Tmax&quot;,&quot;Tmin&quot;,&quot;Precip&quot;,&quot;CO2&quot;)
head(My_meteo)</code></pre>
<pre><code>##   Year Day       Tmax      Tmin Precip      CO2
## 1 2004   1 -14.280000 -20.70000  0.306 384.4005
## 2 2004   2 -13.340000 -17.90000  0.203 384.3611
## 3 2004   3  -1.859991 -13.34000  0.401 384.3216
## 4 2004   4  -8.299994 -24.65999  0.000 384.2822
## 5 2004   5 -18.000010 -28.14001  0.157 384.2427
## 6 2004   6 -17.900000 -20.32000  0.109 384.2033</code></pre>
<p>The columns are:</p>
<ul>
<li><p><em>Year</em> is the year of the observation</p></li>
<li><p><em>Day</em> is the day of the year of the observation
(1-365)</p></li>
<li><p><em>Tmax</em> is the daily maximum temperature
(<em>Â°C</em>)</p></li>
<li><p><em>Tmin</em> is the daily minimum temperature
(<em>Â°C</em>)</p></li>
<li><p><em>Precip</em> is the daily precipitation sum
(<em>cm</em>)</p></li>
<li><p><em>CO2</em> is daily CO2 concentration (<em>ppm</em>)</p></li>
</ul>
<p>Once you have loaded the meteorological data you must create a
temporal data frame with these data (same procedure than 1a) and gap
fill these data (same procedure than 1b).</p>
<pre class="r"><code>My_meteo = mutate(My_meteo, Date = as.Date(paste(My_meteo$Year,My_meteo$Day), format=&#39;%Y %j&#39;))
My_meteo = as_tsibble(My_meteo, index = Date)
My_meteo = My_meteo %&gt;%
  fill_gaps(Day = 366) %&gt;%
  tidyr::fill(Tmax, .direction = &quot;down&quot;) %&gt;%
  tidyr::fill(Tmin, .direction = &quot;down&quot;) %&gt;%
  tidyr::fill(Precip, .direction = &quot;down&quot;) %&gt;%
  tidyr::fill(CO2, .direction = &quot;down&quot;) %&gt;%
  tidyr::fill(Year, .direction = &quot;down&quot;)</code></pre>
<p><strong>(3a) Find the meteorological or environmental variable
(<em>Tmax</em>, <em>Tmin</em>, <em>Precip</em> or <em>CO2</em>) that
correlates the most with the <em>GapFilled_NEP</em> daily time series.
(1 point)</strong></p>
<p><strong>(3b) Join the flux and meteorological tables
(<em>inner_join</em>) and plot the relationship (scatterplot) between
the variable found in 3a (x-axis) and <em>GapFilled_NEP</em> (y-axis).
Comment on this relationship. (1 point)</strong></p>
<p><strong>(3c) Extend the previous GAM model (2b) including a quadratic
term for the variable found in 2a. Inspect and interpret the output of
the new GAM model (summary function). Compare the AIC of this new model
to the models from 2a and 2b. Visualize the model predictions (fitted
values) against the observed data, using: a scatterplot of GapFilled_NEP
vs the used climate variable; a scatterplot of GapFilled_NEP vs DOY (Day
of Year). (2 point). </strong></p>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
